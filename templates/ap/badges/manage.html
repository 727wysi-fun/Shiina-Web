<#include "/ap/assets/base.html">

<!-- Подключаем Cropperjs библиотеку -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<div class="container-fluid bg-body-tertiary border-bottom p-3">
    <div class="row align-items-center">
        <div class="col-auto">
            <h5 class="mb-0">
                <i class="fas fa-medal"></i> Управление значками
            </h5>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Форма для загрузки нового бейджа -->
            <div class="card mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Добавить новый значок
                    </h5>
                </div>
                <div class="card-body">
                    <form id="badgeUploadForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="badgeName" class="form-label">Название значка</label>
                                    <input type="text" class="form-control" id="badgeName" placeholder="Например: Top Player" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="badgeImage" class="form-label">Изображение</label>
                                    <input type="file" class="form-control" id="badgeImage" accept=".png,.jpg,.jpeg,.gif,.webp" required>
                                    <small class="text-muted">Поддерживаемые форматы: PNG, JPG, JPEG, GIF, WebP (макс. 2МБ). Соотношение: 16:9</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="badgeDescription" class="form-label">Описание</label>
                            <textarea class="form-control" id="badgeDescription" rows="3" placeholder="Описание значка и его назначение" required></textarea>
                        </div>
                        <div class="mb-3">
                            <div id="badgePreview" style="display: none;">
                                <small class="text-muted">Предпросмотр (16:9):</small>
                                <div class="mt-2">
                                    <img id="previewImage" src="" alt="Preview" style="max-width: 300px; max-height: 169px; border-radius: 4px;">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Загрузить значок
                        </button>
                    </form>
                </div>
            </div>

            <!-- Список существующих бейджей -->
            <div class="card">
                <div class="card-header bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Список значков</h5>
                        <span class="badge bg-secondary" id="badgeCount">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Превью</th>
                                    <th>Название</th>
                                    <th>Описание</th>
                                    <th>Владельцы</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                <#if badges??>
                                    <#list badges as badge>
                                    <tr>
                                        <td>
                                            <img src="${badge.imageUrl}" alt="${badge.name}" style="width: 80px; height: 45px; border-radius: 4px; object-fit: cover;">
                                        </td>
                                        <td><strong>${badge.name}</strong></td>
                                        <td><small>${badge.description!'—'}</small></td>
                                        <td>
                                            <span class="badge bg-info">${badge.ownerCount!'0'}</span>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="openAssignBadgeModal('${badge.id?c}', '${badge.name}')">
                                                <i class="fas fa-user-plus"></i> Назначить
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="viewBadgeOwners('${badge.id?c}', '${badge.name}')">
                                                <i class="fas fa-users"></i> Просмотр
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBadge('${badge.id?c}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    </#list>
                                <#else>
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <i class="fas fa-medal text-muted me-2"></i>
                                            Значки пока не добавлены
                                        </td>
                                    </tr>
                                </#if>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для назначения значков -->
<div class="modal fade" id="assignBadgeModal" tabindex="-1" aria-labelledby="assignBadgeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignBadgeModalLabel">Назначить значок пользователям</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="userSearch" class="form-label">Поиск пользователя</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="userSearch" placeholder="Введите имя пользователя...">
                        <button class="btn btn-outline-secondary" type="button" id="searchUserBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="userSearchResults" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                    <!-- Результаты поиска будут здесь -->
                </div>
                <div class="mb-3">
                    <label class="form-label">Выбранные пользователи</label>
                    <div id="selectedUsers" class="border rounded p-2" style="min-height: 100px;">
                        <!-- Выбранные пользователи будут отображаться здесь -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="assignBadgeBtn" disabled>Назначить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра владельцев бейджа -->
<div class="modal fade" id="badgeOwnersModal" tabindex="-1" aria-labelledby="badgeOwnersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="badgeOwnersModalLabel">Владельцы значка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="badgeOwnersContainer" style="max-height: 400px; overflow-y: auto;">
                    <!-- Список владельцев будет здесь -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для обрезки изображения -->
<div class="modal fade" id="cropImageModal" tabindex="-1" aria-labelledby="cropImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropImageModalLabel">Обрезать изображение значка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="max-height: 400px; overflow: auto;">
                    <img id="cropperImage" src="" alt="Cropper" style="max-width: 100%;">
                </div>
                <div class="mt-3">
                    <small class="text-muted">Совет: Перетягивайте края и углы для выбора нужной области, затем нажмите "Применить обрезку"</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="applyCropBtn">
                    <i class="fas fa-crop me-2"></i>Применить обрезку
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== ЗАГРУЗКА И ОБРЕЗКА БЕЙДЖЕЙ =====
    const badgeUploadForm = document.getElementById('badgeUploadForm');
    const badgeImageInput = document.getElementById('badgeImage');
    const previewImage = document.getElementById('previewImage');
    const badgePreviewDiv = document.getElementById('badgePreview');
    
    let cropper = null;
    let croppedImageBlob = null;

    // Предпросмотр изображения при выборе файла
    if (badgeImageInput) {
        badgeImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Показываем превью
                    previewImage.src = event.target.result;
                    badgePreviewDiv.style.display = 'block';
                    
                    // Подготавливаем изображение для кропа
                    const cropperImageElement = document.getElementById('cropperImage');
                    cropperImageElement.src = event.target.result;
                    
                    // Уничтожаем старый кроппер если существует
                    if (cropper) {
                        cropper.destroy();
                    }
                    
                    // Инициализируем новый кроппер
                    cropper = new Cropper(cropperImageElement, {
                        aspectRatio: 16 / 9,
                        viewMode: 1,
                        autoCropArea: 0.9,
                        responsive: true,
                        restore: true,
                        guides: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: true,
                        background: true,
                    });
                    
                    // Открываем модальное окно кропа
                    new bootstrap.Modal(document.getElementById('cropImageModal')).show();
                };
                reader.readAsDataURL(file);
            }
        });

        // Обработка применения обрезки
        document.getElementById('applyCropBtn').addEventListener('click', function() {
            if (!cropper) return;
            
            const canvas = cropper.getCroppedCanvas({
                maxWidth: 1024,
                maxHeight: 576,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });
            
            canvas.toBlob(function(blob) {
                croppedImageBlob = blob;
                // Обновляем превью
                previewImage.src = canvas.toDataURL();
                // Закрываем модаль
                bootstrap.Modal.getInstance(document.getElementById('cropImageModal')).hide();
                showSuccessNotification('Изображение обрезано успешно');
            }, 'image/png');
        });

        // Обработка загрузки бейджа
        badgeUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const badgeName = document.getElementById('badgeName').value.trim();
            const badgeDescription = document.getElementById('badgeDescription').value.trim();
            
            if (!badgeName || !badgeDescription) {
                showErrorNotification('Заполните все поля');
                return;
            }
            
            if (!croppedImageBlob && !badgeImageInput.files[0]) {
                showErrorNotification('Выберите и обрежьте изображение');
                return;
            }

            // Используем обрезанное изображение если оно есть, иначе оригинал
            const imageBlob = croppedImageBlob || badgeImageInput.files[0];
            
            // Проверяем размер файла (макс 2MB)
            if (imageBlob.size > 2 * 1024 * 1024) {
                showErrorNotification('Размер файла не должен превышать 2МБ');
                return;
            }

            const btn = badgeUploadForm.querySelector('button[type="submit"]');
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Загрузка...';

            const formData = new FormData();
            formData.append('image', imageBlob, 'badge.png');
            formData.append('name', badgeName);
            formData.append('description', badgeDescription);

            fetch('/ap/badges/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Server returned ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (data.success) {
                    showSuccessNotification('Значок успешно загружен!');
                    badgeUploadForm.reset();
                    badgePreviewDiv.style.display = 'none';
                    croppedImageBlob = null;
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showErrorNotification(data.error || 'Ошибка при загрузке');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showErrorNotification(error.message || 'Ошибка при загрузке значка');
            });
        });
    }

    // ===== УПРАВЛЕНИЕ БЕЙДЖАМИ =====
    let currentBadgeId = null;
    let currentBadgeName = null;
    const selectedUsers = new Set();

    window.viewBadgeOwners = function(badgeId, badgeName) {
        const ownersContainer = document.getElementById('badgeOwnersContainer');
        const modal = document.getElementById('badgeOwnersModal');
        const label = document.getElementById('badgeOwnersModalLabel');
        
        label.textContent = 'Владельцы значка "' + badgeName + '"';
        ownersContainer.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm me-2"></span>Загрузка...</div>';
        
        // Запрашиваем список пользователей с этим бейджем
        fetch('/ap/api/badges?action=get_owners&badge_id=' + badgeId, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.owners && data.owners.length > 0) {
                ownersContainer.innerHTML = data.owners.map(owner => {
                    const countryCode = owner.country || 'xx';
                    return '<div class="d-flex justify-content-between align-items-center border-bottom p-2">' +
                        '<div class="d-flex align-items-center">' +
                            '<img src="/img/flags/' + countryCode + '.svg" alt="' + countryCode + '" class="me-2 rounded" style="width: 20px; height: 15px;">' +
                            '<div>' +
                                '<div><strong>' + owner.username + '</strong></div>' +
                                '<small class="text-muted">#' + owner.id + '</small>' +
                            '</div>' +
                        '</div>' +
                        '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBadgeFromUser(' + badgeId + ', ' + owner.id + ', \'' + badgeName + '\')">' +
                            '<i class="fas fa-times"></i> Удалить' +
                        '</button>' +
                    '</div>';
                }).join('');
            } else {
                ownersContainer.innerHTML = '<p class="text-muted text-center py-4">Нет пользователей с этим значком</p>';
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            ownersContainer.innerHTML = '<p class="text-danger">Ошибка при загрузке списка владельцев</p>';
        });
        
        new bootstrap.Modal(modal).show();
    };

    window.removeBadgeFromUser = function(badgeId, userId, badgeName) {
        if (!confirm('Удалить значок "' + badgeName + '" у этого пользователя?')) {
            return;
        }

        fetch('/ap/api/badges?action=remove&badge_id=' + badgeId + '&user_id=' + userId, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessNotification('Значок удалён у пользователя');
                // Перезагружаем список владельцев
                const modal = bootstrap.Modal.getInstance(document.getElementById('badgeOwnersModal'));
                if (modal) {
                    viewBadgeOwners(badgeId, badgeName);
                }
            } else {
                showErrorNotification(data.error || 'Ошибка при удалении');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showErrorNotification('Ошибка при удалении значка');
        });
    };

    window.openAssignBadgeModal = function(badgeId, badgeName) {
        currentBadgeId = badgeId;
        currentBadgeName = badgeName;
        selectedUsers.clear();
        document.getElementById('selectedUsers').innerHTML = '';
        document.getElementById('userSearch').value = '';
        document.getElementById('userSearchResults').innerHTML = '';
        document.getElementById('assignBadgeBtn').disabled = true;
        
        if (document.getElementById('assignBadgeModalLabel')) {
            document.getElementById('assignBadgeModalLabel').textContent = 'Назначить "' + badgeName + '" пользователям';
        }
        
        new bootstrap.Modal(document.getElementById('assignBadgeModal')).show();
    };

    const userSearchInput = document.getElementById('userSearch');
    const searchUserBtn = document.getElementById('searchUserBtn');
    
    function handleUserSearch() {
        const searchTerm = userSearchInput.value.trim();
        if (searchTerm.length < 2) {
            document.getElementById('userSearchResults').innerHTML = '';
            return;
        }

        fetch('/api/v1/search_users?q=' + encodeURIComponent(searchTerm))
            .then(response => response.json())
            .then(users => displaySearchResults(users))
            .catch(error => {
                console.error('Ошибка при поиске:', error);
                document.getElementById('userSearchResults').innerHTML = '<p class="text-danger ps-2">Ошибка при поиске</p>';
            });
    }

    function displaySearchResults(users) {
        const resultsContainer = document.getElementById('userSearchResults');
        if (!users || users.length === 0) {
            resultsContainer.innerHTML = '<p class="text-muted ps-2">Пользователи не найдены</p>';
            return;
        }
        
        resultsContainer.innerHTML = users.map(user => {
            const countryCode = user.country || 'xx';
            return '<button type="button" class="list-group-item list-group-item-action d-flex align-items-center" ' +
                   'onclick="selectUser(\'' + user.id + '\', \'' + user.username + '\', \'' + countryCode + '\')">' +
                   '<img src="/img/flags/' + countryCode + '.svg" alt="' + countryCode + '" class="me-2 rounded" style="width: 20px; height: 15px;">' +
                   '<span>' + user.username + '</span>' +
                   '<small class="ms-auto text-muted">#' + user.id + '</small>' +
                   '</button>';
        }).join('');
    }

    window.selectUser = function(userId, username, country) {
        if (selectedUsers.has(userId)) return;
        
        selectedUsers.add(userId);
        const userElement = document.createElement('div');
        userElement.className = 'badge bg-info me-2 mb-2 p-2';
        userElement.setAttribute('data-user-id', userId);
        userElement.innerHTML = 
            '<img src="/img/flags/' + country + '.svg" alt="' + country + '" style="width: 16px; height: 12px;" class="me-1 rounded">' +
            '<span>' + username + '</span>' +
            '<button type="button" class="btn-close btn-close-white ms-2" onclick="removeUser(\'' + userId + '\')" style="font-size: 0.75em;"></button>';
        document.getElementById('selectedUsers').appendChild(userElement);
        document.getElementById('assignBadgeBtn').disabled = selectedUsers.size === 0;
        
        document.getElementById('userSearchResults').innerHTML = '';
        document.getElementById('userSearch').value = '';
    };

    window.removeUser = function(userId) {
        selectedUsers.delete(userId);
        document.getElementById('selectedUsers').querySelectorAll('.badge').forEach(badge => {
            if (badge.getAttribute('data-user-id') == userId) {
                badge.remove();
            }
        });
        document.getElementById('assignBadgeBtn').disabled = selectedUsers.size === 0;
    };

    document.getElementById('assignBadgeBtn').addEventListener('click', function() {
        if (!currentBadgeId || selectedUsers.size === 0) return;

        const btn = this;
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Назначение...';

        const assignPromises = Array.from(selectedUsers).map(userId =>
            fetch('/ap/api/badges?action=assign&badge_id=' + currentBadgeId + '&user_id=' + userId, {
                method: 'POST'
            })
            .then(response => response.json())
        );

        Promise.all(assignPromises)
            .then(results => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                const allSuccess = results.every(r => r.success);
                if (allSuccess) {
                    bootstrap.Modal.getInstance(document.getElementById('assignBadgeModal')).hide();
                    showSuccessNotification(currentBadgeName + ' назначен ' + selectedUsers.size + ' пользователю(ам)');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showErrorNotification('Некоторые назначения не удались');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showErrorNotification('Ошибка при назначении');
            });
    });

    userSearchInput.addEventListener('input', handleUserSearch);
    searchUserBtn.addEventListener('click', handleUserSearch);
    userSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleUserSearch();
        }
    });

    // Удаление бейджей
    window.deleteBadge = function(badgeId) {
        if (!confirm('Вы уверены? Это удалит значок и все его связи с пользователями!')) {
            return;
        }

        fetch('/ap/api/badges?action=delete&badge_id=' + badgeId, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessNotification('Значок успешно удален');
                setTimeout(() => location.reload(), 1000);
            } else {
                showErrorNotification(data.error || 'Ошибка при удалении');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showErrorNotification('Ошибка при удалении значка');
        });
    };

    function showSuccessNotification(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    function showErrorNotification(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    // Обновляем счётчик бейджей
    const badgeCount = document.querySelectorAll('tbody tr:not(:has(td[colspan]))').length;
    if (document.getElementById('badgeCount')) {
        document.getElementById('badgeCount').textContent = badgeCount;
    }

    // Исправление для правильного закрытия модальных окон
    const badgeOwnersModal = document.getElementById('badgeOwnersModal');
    if (badgeOwnersModal) {
        badgeOwnersModal.addEventListener('hidden.bs.modal', function() {
            // Удаляем все оставшиеся бэкдропы
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            // Восстанавливаем scroll на body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
        });
    }

    const assignBadgeModal = document.getElementById('assignBadgeModal');
    if (assignBadgeModal) {
        assignBadgeModal.addEventListener('hidden.bs.modal', function() {
            // Удаляем все оставшиеся бэкдропы
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            // Восстанавливаем scroll на body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
        });
    }

    const cropImageModal = document.getElementById('cropImageModal');
    if (cropImageModal) {
        cropImageModal.addEventListener('hidden.bs.modal', function() {
            // Удаляем все оставшиеся бэкдропы
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            // Восстанавливаем scroll на body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
        });
    }
});
</script>
